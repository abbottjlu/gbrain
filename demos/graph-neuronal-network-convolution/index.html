<html>
	<head>
		<title>SCEJS ConvNeuronalNetwork</title>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

        <!--<script src="../../dist/scejs/SCEJS.min.js"></script>-->

        <script src="../../dist/gbrain/Graph.class.js"></script>
        <script src="../../dist/gbrain/KERNEL_DIR.class.js"></script>
        <script src="../../dist/gbrain/KERNEL_ADJMATRIX_UPDATE.class.js"></script>
        <script src="../../dist/gbrain/VFP_NODE.class.js"></script>
        <script src="../../dist/gbrain/VFP_NODEPICKDRAG.class.js"></script>
        <script src="../../dist/gbrain/ProccessImg.class.js"></script>
        <script src="../../dist/gbrain/gbrain.js"></script>
        <script src="../../dist/gbrain/gbrain-rl.js"></script>

        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-3687403-4', 'auto');
            ga('send', 'pageview');

        </script>
	</head>

	<body>
        <div style="width:20%;display:inline-block">
            T for top view<br />
            Alt+LeftMouse for Orbit<br />
            Alt+MiddleMouse for Pan<br />
            P for perspective view<br />
            WASD for to move<br />
            <br />

            [-1.0,1.0] = [0,255] = [<span style='background-color:red'>_</span>,<span style='background-color:green'>_</span>] <br />
            <div id='elem_bgColor' style='width:150px;height:150px;border:2px solid #333;text-align: center;'>
                <div id='elem_fgColor'>SCEJS</div>
            </div>

            <button id="BTNID_AFFERENCEDATA">random input data</button> <br />
            <button id="BTNID_EFFERENCEDATA0">train animal</button> <br />
            <button id="BTNID_EFFERENCEDATA1">train house</button> <br />
            <!--<button id="BTNID_NETWORKSTEP">network step</button> <br />-->
        </div>
        <div style="width:79%;display:inline-block">
            <div id="SCEJS"></div>
        </div>
		<script>
            var num_inputs = 8*8; // 9 eyes, each sees 3 numbers (wall, green, red thing proximity)
            var num_actions = 5; // 5 possible angles agent can turn
            var temporal_window = 0; // amount of temporal memory. 0 = agent lives in-the-moment :)
            var network_size = num_inputs*temporal_window + num_actions*temporal_window + num_inputs;
            var layer_defs = [];
            layer_defs.push({"type": "input", "out_sx": Math.sqrt(network_size), "out_sy": Math.sqrt(network_size)});
            layer_defs.push({"type": "conv", "activation": "relu"});
            layer_defs.push({"type": "fc", "num_neurons": 15, "activation": "relu"});
            layer_defs.push({"type": "fc", "num_neurons": 15, "activation": "relu"});
            layer_defs.push({"type": "regression", "num_neurons": num_actions});

            var gbrain = new GBrainRL({
                "num_inputs": num_inputs,
                "num_actions": num_actions,
                "temporal_window": temporal_window,
                "experience_size": 30000,
                "gamma": 0.7,
                "learning_steps_total": 200000,
                "learning_steps_burnin": 100,
                "epsilon_min": 0.05,
                "epsilon_test_time": 0.05,
                "start_learn_threshold": 500,
                "batch_repeats": 1, // 1*7 (1batch_repeats=7gpu training sets)
                "learning_rate": 0.001, // 0.001 0.0005
                "layer_defs": layer_defs});

            gbrain.stopLearning();

            var render = function() {
                gbrain.gbrain.tick();
                requestAnimFrame(render);
            };
            render();

            var arr = [ 0,0,0,0,0,0,0,0,
                        0,1,1,1,1,1,1,0,
                        0,0,0,0,0,0,1,0,
                        0,0,0,0,0,0,1,0,
                        0,0,1,1,1,1,1,0,
                        0,0,0,0,0,0,1,0,
                        0,1,1,1,1,1,1,0,
                        0,0,0,0,0,0,0,0];
            gbrain.forward([arr], function(actionix) {

            });
		</script>


		<script>
		    var elem_bgColor = document.getElementById("elem_bgColor");
            var elem_fgColor = document.getElementById("elem_fgColor");

            document.getElementById("BTNID_AFFERENCEDATA").addEventListener("click", (function() {
                loadImg();
            }).bind(this));

            document.getElementById("BTNID_EFFERENCEDATA0").addEventListener("click", (function() {
                graph.setEfferentData({ "data": [0.0],
                                        "onLearned": (function(output) { // output[3] = error

                                        }).bind(this)});
                elem_fgColor.innerHTML = "animal";
            }).bind(this));
            document.getElementById("BTNID_EFFERENCEDATA1").addEventListener("click", (function() {
                graph.setEfferentData({ "data": [1.0],
                                        "onLearned": (function(output) { // output[3] = error

                                        }).bind(this)});
                elem_fgColor.innerHTML = "house";
            }).bind(this));


            var inputImage = function(img) {
                elem_fgColor.innerHTML = "";
                var thumb = img.cloneNode(true);
                thumb.width = 60;
                thumb.height = 60;
                elem_fgColor.appendChild(thumb);

                var arr = new Utils().getUint8ArrayFromHTMLImageElement(img);
                console.log(arr.length);
                var ad = {};
                for(var x=0; x < W; x++) {
                    for(var y=0; y < H; y++) {
                        var ww = parseInt(img.width/W);
                        var hh = parseInt(img.height/H);
                        var id = (((y*hh)*img.width)+(x*ww))*4;
                        ad["0_"+y+"_"+x] = (arr[id]/255);
                    }
                }
                ad["efferentNeuron"] = ["color"];
                ad["onAction"] = (function(data) {
                    /*console.log("W output: %O", data.color.output);
                    if(data.color.output < 0.0)
                        elem_fgColor.innerHTML += "animal";
                    else
                        elem_fgColor.innerHTML += "house";*/
                }).bind(this);

                graph.setAfferentData(ad);
            };
            var loadImgL = function(url) {
                var img = new Image();
                img.addEventListener('load', function() {
                    inputImage(this);
                });
                img.src = url;
            };
            //loadImgL("house-00.jpg");

            var loadImg = function() {
                elem_fgColor.innerHTML = "Loading image...";

                var urls = ["http://www.image-net.org/api/text/imagenet.synset.geturls?wnid=n02084071",
                    "http://www.image-net.org/api/text/imagenet.synset.geturls?wnid=n03544360"];
                var req = new XMLHttpRequest();
                var idu = Math.round(Math.random());
                req.open("GET", urls[idu], true);
                req.responseType = "blob";
                req.onload = (function(onload) {
                    var filereader = new FileReader();
                    filereader.onload = (function(onload, event) {
                        var text = event.target.result;

                        var arrImgUrl = text.split("\n");
                        var imgUrl = arrImgUrl[parseInt(Math.random()*arrImgUrl.length)];

                        var img = new Image();
                        img.crossOrigin = "Anonymous";
                        img.addEventListener('load', function() {
                            inputImage(this);
                        });
                        img.addEventListener('error', function() {
                            loadImg();
                        });
                        img.src = imgUrl;

                        if(onload != undefined && typeof(onload) == 'function')
                            onload();
                    }).bind(this, onload);
                    filereader.readAsText(req.response);
                }).bind(this, onload);
                req.send(null);
            };
            //loadImg();
		</script>
	</body>
</html>
